<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Security Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../static/jpg/02.png" type="image/x-icon">
  <link rel="stylesheet" href="../static/settingslight.css">
</head>

<body>
  <main class="page">
    <a href="/" class="home-link">Home</a>
    <h1>Security settings</h1>
    <p class="subtitle">Manage authentication and account protection</p>

    <!-- ACCOUNT -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Account</div>
          <div class="card-desc">Primary account information</div>
        </div>
      </div>

      <div class="row">
        <span>Email</span>
        <strong>{{.Email}}</strong>
      </div>
    </section>

    <!-- PASSKEY -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Passkey (WebAuthn)</div>
          <div class="card-desc">Passwordless authentication using device biometrics</div>
        </div>
      </div>

      <div class="row">
        {{if .HasPasskey}}
          <div class="status">
            <span class="dot success"></span>
            <span>Configured</span>
          </div>

          <div class="actions">
            <button>Manage</button>
            <form method="POST" action="/webauthn/credentials/delete">
              <button type="submit" onclick="return confirm('This will remove all passkeys. Continue?')">Reset all passkey</button>
            </form>
          </div>
        {{else}}
          <div class="status">
            <span class="dot danger"></span>
            <span>Not configured</span>
          </div>

          <button class="primary" onclick="registerPasskey()">
            Add passkey
          </button>
        {{end}}
      </div>
    </section>

    <!-- FUTURE EXTENSIONS -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Two-Factor Authentication</div>
          <div class="card-desc">Extra security layer for your account</div>
        </div>
      </div>

      <div class="row">
        <span>Authenticator app (TOTP)</span>
        <button disabled>Coming soon</button>
      </div>

      <div class="row">
        <span>Backup codes</span>
        <button disabled>Coming soon</button>
      </div>
    </section>
  </main>

  <script>
    async function registerPasskey() {
      const start = await fetch('/webauthn/register/start', {
        method: 'POST',
        credentials: 'include'
      });
    
      if (!start.ok) {
        alert('Not authorized');
        return;
      }
    
      const options = await start.json();
    
      options.publicKey.challenge =
        base64urlToBuffer(options.publicKey.challenge);
    
      options.publicKey.user.id =
        base64urlToBuffer(options.publicKey.user.id);
    
      const cred = await navigator.credentials.create({
        publicKey: options.publicKey
      });
    
      if (!cred) {
        alert('Cancelled');
        return;
      }
    
      const credential = {
        id: cred.id,
        rawId: bufferToBase64url(cred.rawId),
        type: cred.type,
        response: {
          attestationObject: bufferToBase64url(
            cred.response.attestationObject
          ),
          clientDataJSON: bufferToBase64url(
            cred.response.clientDataJSON
          )
        }
      };
    
      const finish = await fetch('/webauthn/register/finish', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(credential)
      });
    
      if (finish.ok) {
        alert('Passkey added');
        location.reload();
      } else {
        alert('Registration failed');
      }
    }
    
  
    function base64urlToBuffer(base64url) {
      const padding = '='.repeat((4 - base64url.length % 4) % 4);
      const base64 = (base64url + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');
    
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
    
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
    
      return bytes;
    }
    
    function bufferToBase64url(buffer) {
      return btoa(
        String.fromCharCode(...new Uint8Array(buffer))
      )
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }
    </script>
</body>
</html>

<!-- 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Security settings</title>
</head>
<body>

<h2>Security settings</h2>

<p>Email: {{.Email}}</p>

{{if .HasPasskey}}
  <p>✅ Passkey configured</p>
{{else}}
  <p>❌ Passkey not configured</p>
  <button onclick="registerPasskey()">Add passkey</button>
{{end}}

<script>
  async function registerPasskey() {
    const start = await fetch('/webauthn/register/start', {
      method: 'POST',
      credentials: 'include'
    });
  
    if (!start.ok) {
      alert('Not authorized');
      return;
    }
  
    const options = await start.json();
  
    options.publicKey.challenge =
      base64urlToBuffer(options.publicKey.challenge);
  
    options.publicKey.user.id =
      base64urlToBuffer(options.publicKey.user.id);
  
    const cred = await navigator.credentials.create({
      publicKey: options.publicKey
    });
  
    if (!cred) {
      alert('Cancelled');
      return;
    }
  
    const credential = {
      id: cred.id,
      rawId: bufferToBase64url(cred.rawId),
      type: cred.type,
      response: {
        attestationObject: bufferToBase64url(
          cred.response.attestationObject
        ),
        clientDataJSON: bufferToBase64url(
          cred.response.clientDataJSON
        )
      }
    };
  
    const finish = await fetch('/webauthn/register/finish', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(credential)
    });
  
    if (finish.ok) {
      alert('Passkey added');
      location.reload();
    } else {
      alert('Registration failed');
    }
  }
  

  function base64urlToBuffer(base64url) {
    const padding = '='.repeat((4 - base64url.length % 4) % 4);
    const base64 = (base64url + padding)
      .replace(/-/g, '+')
      .replace(/_/g, '/');
  
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
  
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
  
    return bytes;
  }
  
  function bufferToBase64url(buffer) {
    return btoa(
      String.fromCharCode(...new Uint8Array(buffer))
    )
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=+$/, '');
  }
  </script>
  
  
  

</body>
</html> -->
